---
title: "Project_1_Main"
author: "Michael Arango, Yeshwant Chillakuru, Jackson Crum"
date: "February 22, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggmap)
library(dplyr)
library(tidyverse)
library(tidyr)

# date format library
library(lubridate)

# geolibraries
library(rgdal)
library(sp)
library(raster)
```

#Description of the Dataset

##Reading the Data into R
```{r Reading in Data, tidy=TRUE, results='hide'}
getwd()
tickets <- data.frame(read.csv('Muni_Driver_Reported_Transit_Only_Lane_Violations.csv', header = T, sep = ","))
```

##Checking Dimensions and Structure of the Dataset 
```{r Variables, tidy=T, results='hide'}
#Check dimensions of dataset 
dim(tickets)
#Check variable names
colnames(tickets)
#Examine structure of the data
str(tickets)
```

##Summary of the Dataset 

The dataset consists of San Francisco Municipal Transportation Agency (SFMTA) driver reported transit only lane violations from March 2008 to February 2015. The dataset contains 17,178 observations and 18 variables. The data were obtained from the US government's open data site at https://catalog.data.gov/dataset/muni-driver-reported-transit-only-lane-violations. 

###Description of Variables in the dataset: 

* `Object.ID` -- Unique key that corresponds to each observation
* `Ticket.Number` -- Unique number that corresponds to each ticket catalogued with the Superior Court of San Francisco
* `Citation.Issue.Date` -- The date (MM/DD/YY) that the traffic only lane violation citation was issued
* `Citation.Issue.Month` -- The month (MM) that the traffic only lane violation citation was issued; This column was completely blank when downloaded
* `Citation.Issue.Time` -- The time of day (HH:MM) PST that the traffic only lane violation citation was issued
* `Location` -- The street address where the traffic only lane violation citation was issued
* `Violation.Code` -- A code that corresponds to the type of traffic only lane violation that was committed to warrant issuing a citation
* `Violation` -- Description of the traffic only lane violation issued in the citation
* `Fine.Amount` -- The dollar amount of to be paid for the traffic only lane violation
* `Citation.Status` -- Status of the citation (Open, Closed, Unapplied)
* `Amount.Paid` -- The dollar amount paid for the traffic only lane violation
* `Amount.Due` -- Outstanding balance for the traffic only lane violation 
* `Suspend.Code` -- Code that represents reason for license suspension (Suspended until the driver goes to driving school, pays fine, too many points on license, etc.)
* `Suspend.Process.Date` -- Date the license suspension goes into effect
* `Suspend.Until.Date` -- Date the license suspension is over
* `Disposition.Code` -- The city of San Francisco does not release disposition codes
* `Last.Edited.Date` -- Date that represents the last date the corresponding observation was edited; This column was completely blank when downloaded
* `Geom` -- The latitude and longitude (latitutde, longitude) of the traffic only lane violation 


###Explanations of Violation variable:
 * 'DBL Park' -- Double Parking
 * 'TWAWY ZN#1' and 'TWAWY ZN#2' -- Towaway Zone 1 and Towaway Zone 2
 * 'TRNST ONLY' -- Parking Transit-Only
 * 'PRK PROHIB' -- Tow-Away Zone - Downtown Core
 * 'PK PHB OTD' -- Tow-Away Zone - Outside Downtown Core
 * 'PK FR LN' -- Parking in Fire Lane
 * 'ON SIDEWLK' -- Parking on Sidewalk
 * 'DBL PARK' -- Double Parking
 * 'BUS ZONE' -- Parking in Bus Zone
 * 'OVR 18" C' -- Over 18 inches from Curb
 
 
## Formatting Data
```{r Reformatting Variables, tidy=T, results='hide', message=FALSE}
# Format Date and Month columns
#Change citation issue date from string to month/day/year date variable 
tickets$Citation.Issue.Date <- mdy(tickets$Citation.Issue.Date)
#Populate blank column for citation issue month with month of citation issue date
tickets$Citaton.Issue.Month <- NULL
tickets$Citation.Issue.Month <- month(tickets$Citation.Issue.Date, label = TRUE)

# Convert Amount.Paid from factor to numeric
tickets$Amount.Paid <- as.numeric(tickets$Amount.Paid)
```

## Data Cleaning
```{r Data Cleaning, tidy=T}
#########Consider dropping this chunk if no tickets won in court##########

# New Column "Won.In.Court," based off assumption that if (Citation.Status == 0 && Amount.Due > 0), then "Won.in.Court" = 1. 
tickets$Won.In.Court <- ifelse(tickets$Citation.Status == "Closed" & tickets$Amount.Due > 0, 1, 0)
  ## No tickets won in court

# New Column "Paid.On.Time" (1 = true, 0 = false). Based on assumption that late payments have to pay an extra fine and, thus, Amount.Paid > Fine.Ammount
tickets$Paid.On.Time <- ifelse(tickets$Amount.Paid > tickets$Amount.Due, 1, 0)



# Create column indicating the year the ticket was issued
tickets$Citation.Issue.Year <- year(tickets$Citation.Issue.Date)

# Create column indicating DayOfWeek (Sunday (1) to Saturday (7)) that the ticket was issued
tickets$Citation.Issue.DayOfWeek <- wday(tickets$Citation.Issue.Date)

# Convert Citation.Issue.DayOfWeek from 1, 2, 3, 4, 5, 6, 7 to Mon, Tues, Wed, Thurs, Fri, Sat
tickets$Citation.Issue.DayOfWeek <- wday(tickets$Citation.Issue.Date, label = TRUE)

# Create column indicating whether the ticket was issued on: weekday (1), weekend (0)
tickets$Citation.Issue.Weekday <- ifelse(tickets$Citation.Issue.DayOfWeek >= 2 & tickets$Citation.Issue.DayOfWeek <= 6, 1, 0)

# Create column for Hour of citation issuance. Drop observations with no Citation.Issue.Time data. ***0 OBSERVATIONS DROPPED***
tickets <- tickets[!(is.na(tickets$Citation.Issue.Time) | tickets$Citation.Issue.Time == ""), ]
outTime <- strsplit(as.character(tickets$Citation.Issue.Time), ":")
tickets <- data.frame(tickets, do.call(rbind, outTime))
names(tickets)[names(tickets) == "X1"] <- "Citation.Issue.Hour"
names(tickets)[names(tickets) == "X2"] <- "Citation.Issue.Minute"
tickets$Citation.Issue.Hour <- as.numeric(as.character(tickets$Citation.Issue.Hour))
tickets$Citation.Issue.Minute <- NULL
rm(outTime)

# Create column from Month-Year
tickets <- within(tickets, Citation.Issue.MonthYear <- paste(Citation.Issue.Month, "-", Citation.Issue.Year, sep=""))

# Drop "Unapplied" and empty/NA observations within Citation.Status. Unapplied result is outside the scope of this project. ***84 OBSERVATIONS DROPPED***
tickets <- tickets[!(is.na(tickets$Citation.Status) | tickets$Citation.Status =="" | tickets$Citation.Status == "Unapplied"),]

# Drop extraneous variables: Object.ID (just row index), Location (Not need street address b/c we have latitude and longitude), Last.Edited.Date (empty column), Suspend.Code (NA), Disposition.Code (NA), Violation.Code (have this info in Violation variable)
tickets$Object.ID <- NULL
tickets$Location <- NULL
tickets$Last.Edited.Date <- NULL
tickets$Suspend.Code <- NULL
tickets$Disposition.Code <- NULL
tickets$Violation.Code <- NULL

# Drop "NO VIOL" observations in Violation variable. ***1 OBSERVATIONS DROPPED***
tickets <- tickets[!(tickets$Violation == "NO VIOL"),]

# Create neighborhood column using Lat/Long and Census Block Data from shp file
## Thanks to Shekeine for instructions: http://stackoverflow.com/questions/29872109/binning-longitude-latitude-labeled-data-by-census-block-id
## Load Census tract data for San Fransisco
#tractSF <- shapefile('Analysis Neighborhoods - 2010 census tracts assigned to neighborhoods/geo_export_72577790-b6d5-439f-9b51-edc69b942ac6.shp')
```

###Dropped Observations

* We dropped all observations with no Geom data
    * This was only 21 of the 17,178 observations
* We dropped all observations with no information on the time of the citation
    * Every observation had information on the time of the citation
* We dropped all observations where citation status was not specified or "unapplied"
    * We determined "Unapplied" citations are outside the scope of this project
    * This only led to 84 observations being dropped
* Dropping extraneous variables did not affect the number of observations in the dataset
* We dropped Violations where the listed violation was determined to be "No Violation"
    * This led to 1 observation being dropped
    * It is worth noting that only 1 violation was deemed not to be a violation

#Cleaned Dataset

```{r Cleaned Dataset Properties, tidy=T, results='hide', message=FALSE}
#Check dimensions of cleaned dataset 
dim(tickets)
#Check all variable names
colnames(tickets)
#Examine structure of cleaned dataset
str(tickets)
```

##Description of Cleaned Dataset


```{r Basic mapping of violation point data on San Fran map}




sanfran <- c(lon = -122.42, lat = 37.77)
sanfran_map <- get_map(location = sanfran, zoom = 13)
ggmap(sanfran_map) + geom_point(data = tickets, aes(x = Longitude, y = Latitude))

sanfran1 <- c(lon = -122.415, lat = 37.785)
sanfran1_map <- get_map(location = sanfran1, zoom = 14)
ggmap(sanfran1_map) + geom_point(data = tickets, aes(x = Longitude, y = Latitude))
```




# # Analysis of Daily Revenues

```{r Analysis Means}
#Create the week variable
dateRange <- c(tickets$Citation.Issue.Date) 
x <- as.POSIXlt(dateRange) 
tickets$Citation.Issue.Week <- strftime(x,format="%W")

#Daily Analysis
DailyTotals<- tickets %>% group_by(Citation.Issue.Date) %>% summarise(Total = sum(Amount.Paid))

head(DailyTotals)

AverageDay <- mean(DailyTotals$Total)
AverageDay

MedianDay <- median(DailyTotals$Total)
MedianDay

Daily <- DailyTotals$Total

var(Daily)
sd(Daily)
quantile(Daily, c(.1, .3, .5, .7, .9))
shapiro.test(Daily)

#EDA Graphs for Rushhour
qqnorm(Daily)
qqline(Daily)


ggplot(DailyTotals, aes(x = Total)) + 
  geom_histogram(aes(y=..density..), colour="black", fill="pink") + 
  geom_density(alpha=.5, fill="red") + 
  geom_vline(xintercept = AverageDay, linetype = "longdash", colour = "blue") + geom_vline(xintercept = MedianDay, linetype = "twodash" , colour = "green")

```

# # Analysis of Weekly Revenues

```{r}

#Weekly Total Revenue Mean compared to each Week's Total Revenue
#Weekly Analysis
WeeklyTotals<- tickets %>% group_by(Citation.Issue.Week, Citation.Issue.Month, Citation.Issue.Year) %>% summarise(Total = sum(Amount.Paid))

head(WeeklyTotals)

mean.Weekly <- mean(WeeklyTotals$Total)
mean.Weekly

MedianWeek <- median(WeeklyTotals$Total)
MedianWeek

Weekly <- WeeklyTotals$Total

var(Weekly)
sd(Weekly)
quantile(Weekly, c(.1, .3, .5, .7, .9))
shapiro.test(Weekly)

qqnorm(Weekly)
qqline(Weekly)

ggplot(WeeklyTotals, aes(x = Total)) + geom_histogram(aes(y = ..density..), fill = "pink", colour = "black", binwidth = 500) + geom_density(alpha=.5, fill="red") + geom_vline(xintercept = AverageWeek, linetype = "longdash", colour = "blue") + geom_vline(xintercept = MedianWeek, linetype = "twodash" , colour = "green")
sd.Week <- sd(WeeklyTotals$Total)
sd.Week


```

# # Analysis of Monthly Revenues

```{r Monthly Revenue}
#Monthly Analysis
MonthlyTotals<- tickets %>% group_by(Citation.Issue.Month, Citation.Issue.Year) %>% summarise(Total = sum(Amount.Paid))

head(MonthlyTotals)


#EDA of Statistics of Monthly Revenue
AverageMonth <- mean(MonthlyTotals$Total)
AverageMonth

MedianMonth <- median(MonthlyTotals$Total)
MedianMonth

Monthly <- MonthlyTotals$Total

var(Monthly)
sd(Monthly)
quantile(Monthly, c(.1, .3, .5, .7, .9))
shapiro.test(Monthly)

#EDA Graphs for Rushhour
qqnorm(Monthly)
qqline(Monthly)



ggplot(MonthlyTotals, aes(x = Total)) + geom_histogram(aes(y = ..density..), fill = "pink", colour = "black", binwidth = 2000) + geom_density(alpha=.5, fill= "red") + geom_vline(xintercept = AverageMonth, linetype = "longdash", colour = "blue") + geom_vline(xintercept = MedianMonth, linetype = "twodash" , colour = "green")

```



# # Is more revenue generated during rush hour or off hours on a typical day

```{r}
a <- RushHour %>% group_by(Citation.Issue.Date) %>% summarise(Revenue = sum(Fine.Amount)) 
a

b <- NonRushHour %>% group_by(Citation.Issue.Date) %>% summarise(Revenue = sum(Fine.Amount)) 
b

ggplot(a, aes(x = Revenue)) + geom_histogram(binwidth = 100, color = "black", fill = "red") + geom_histogram(data = b, aes(x = Revenue), binnwidth = 100, color = "black", fill = "blue", alpha = 0.7)


```

```{r}
TotalWeek <- WeeklyTotals$Total
n.Weekly <- length(TotalWeek)
std.error.Week <- sd.Week / sqrt(n.Weekly)
std.error.Week
lower.limit.Week <- mean.Weekly - (1.96 * std.error.Week)
upper.limit.Week <- mean.Weekly + (1.96 * std.error.Week)
lower.limit.Week
upper.limit.Week
```
```{r}
asshole <- tickets %>% group_by(Violation, Citation.Issue.Year) %>% summarise(count = n())
asshole
```

```{r}
MedianPerWeek <- tickets %>% group_by(Citation.Issue.DayOfWeek) %>% summarise(median = median(Amount.Paid))


MedianPaid <- median(tickets$Amount.Paid)


ggplot(MedianPerWeek, aes(x = Citation.Issue.DayOfWeek, y = median)) + geom_bar(fill = "red", color = "black", stat='identity') + coord_flip() + geom_hline(yintercept = MedianPaid, linetype = "longdash", colour = "blue")

MediansPerMonth<- tickets %>% group_by(Citation.Issue.Month, Citation.Issue.Year) %>% summarise(Median = median(Amount.Paid))

MedianMonthly <- MediansPerMonth %>% unite(Date, Citation.Issue.Month, Citation.Issue.Year, sep = " ")

MedianMonthly <- MedianMonthly %>% filter(Median >= 50)

ggplot(MedianMonthly, aes(x = Date, y = Median)) + geom_bar(stat = 'identity', fill = "red", colour = "black") + geom_hline(yintercept = median(tickets$Amount.Paid), linetype = "longdash", colour = "blue")
```
