---
title: "Project_1_EDA"
author: "Michael Arango, Yeshwant Chillakuru, Jackson Crum"
date: "March 5, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

----------------------------------------------------------------------

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggmap)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(tidyr)
# date format library
library(lubridate)
```


```{r Read in the file, tidy=T, results = 'hide'}
getwd()
tickets <- data.frame(read.csv("tickets.csv", header=T, sep=','))
```

#Violations

##What TOLE violations are most common?
```{r Most common violations, tidy=T, message=FALSE, echo=FALSE}
table(tickets$Violation)
#Plot violations by count 
ggplot(data=tickets, aes(Violation)) + geom_bar()
```

##What TOLE violations produce the most revenue?
```{r violations most revenue, tidy=T, message=FALSE, echo=FALSE}
tickets_by_viol <- tickets %>% group_by(Violation) %>% summarise(Total.Revenue = sum(Amount.Paid))
ggplot(tickets_by_viol, aes(x=Violation, y=Total.Revenue)) + geom_col()



#Create Total Revenue variable for each violation
tickets.violation <- aggregate(tickets[,c("Amount.Paid")], by=list(tickets$Violation), FUN=sum)
tickets.violation <- rename(tickets.violation, Violation = Group.1, Total.Revenue = x)
#Plot Revenue by violation
ggplot(tickets.violation, aes(x=Violation, y=Total.Revenue)) + geom_bar(stat="identity")  + coord_flip() +  geom_text(aes(label=Total.Revenue))
  ##Graph for total revenue of violations looks pretty similar to graph of violation counts above

#Remove total revenue variable
rm(tickets.violation)
```

###What TOLE Violations produce the most revenue on weekends and weekdays?
```{r violations most revenue on weekends/weekdays, tidy=T, message=FALSE, echo=FALSE}
#Create variable that store sum of apount paid by violation and weekday 
tickets.violWeekday <- aggregate(tickets[,c("Amount.Paid")], by=list(tickets$Violation, tickets$Citation.Issue.Weekday), FUN=sum)
  ##Rename the columns of tickets.violWeekday
tickets.violWeekday <- rename(tickets.violWeekday, Violation = Group.1, Weekday = Group.2, Total.Revenue = x)
  ##Create new column for daily average revenue: IF day == weekday, then divide TR by 5; ELSE divide by 2
tickets.violWeekday$Daily.Average.Revenue <- ifelse(tickets.violWeekday$Weekday == 1, tickets.violWeekday$Total.Revenue/5, tickets.violWeekday$Total.Revenue/2)
  ## IF Weekday == 0, weekend; ELSE weekday
tickets.violWeekday$Weekday <- ifelse(tickets.violWeekday$Weekday == 0, "Weekend", "Weekday")

p <- ggplot(tickets.violWeekday, aes(x=Violation, y=Daily.Average.Revenue, fill=Weekday))
p + geom_bar(stat="identity") + coord_flip()

rm(p, tickets.violWeekday)
```

##For the top 3 violations, what hours are most ticketed? 
```{r top 3 violations most ticketed, tidy=T, message=FALSE, echo=FALSE}
#Figure out which violation types are top 3 most common
ViolCount <- tickets %>% group_by(Violation) %>% summarise(freq=n())
topViol <- ViolCount[order(-ViolCount$freq),]
topViol <- topViol[1:3,]
  ##New dataframe with top 3 violations
tickets.topViol <- subset(tickets, tickets$Violation == topViol$Violation[1] | tickets$Violation == topViol$Violation[2] | tickets$Violation == topViol$Violation[3])
  ##Rename column
tickets.topViol <- rename(tickets.topViol, Top.3.Violations = Violation)
 ##Plot top 3 violations by issue hour
p1 <- ggplot(tickets.topViol, aes(Citation.Issue.Hour, fill=Top.3.Violations))
p1 + geom_density(alpha = .6)

table(tickets.topViol$Citation.Issue.Hour)
```

##For the top 3 violations, what is the usual amount paid?

```{r top 3 violations amount paid, tidy=T, message=FALSE, echo=FALSE}
p2 <- ggplot(tickets.topViol, aes(Amount.Paid, fill=Top.3.Violations))
p2 + geom_density(alpha = .6)

#Remove from workspace
rm(p1, p2, topViol, ViolCount, tickets.topViol)
```

##Do TOLE violations vary by hour of the day? 

```{r Violations by hour, tidy=T, message=F}
#Dataframe for number of violations by Hour
Tickets.per.Hour <- tickets %>% group_by(Citation.Issue.Hour) %>% summarise(count = n())
Tickets.per.Hour
  ##Plot violations by hour
ggplot(tickets, aes(x = Citation.Issue.Hour, fill = Violation)) + geom_bar(position = "fill") + scale_x_continuous(breaks = seq(0, 24, 1)) 
# NOTE: The graph shows almost entirely Double Parking and Bus Zone Violations during non-rush-hour and almost entirely Towaway and Prohibited Parking during rush hour
```

```{r Distribution of each Violation by type and hour, tidy=T, message=F, }
#Distribution of Violation by type and hour of day
ggplot(tickets, aes(x = Citation.Issue.Hour)) + geom_histogram(fill = "red", color = "black") + facet_wrap(~Violation)
```

##Do TOLE violations vary by year? 

```{r Violations by year}

```


# Mike EDA 

```{r EDA of Money and Violation variables, tidy=T, message=F}
#Violations
ggplot(data = tickets) + geom_bar(mapping = aes(x = tickets$Violation)) + coord_flip()
  #Violations broken down by year
ggplot(data = tickets) + geom_bar(mapping = aes(x = tickets$Violation, fill = as.factor(tickets$Citation.Issue.Year)), position = "dodge") + coord_flip()

#Fine amount
table(tickets$Fine.Amount)
fine.plot <- ggplot(data = tickets) + geom_bar(mapping = aes(x = tickets$Fine.Amount))
fine.plot
  ##By Violation
fine.plot + facet_wrap(~ tickets$Violation)
  ## It is clear that tickets have a low fine amount and high fine amount. Is it time of day, weekday vs weekend, year, etc.?
ggplot(data = tickets) + geom_bar(mapping = aes(x = tickets$Fine.Amount, fill = tickets$Citation.Issue.Weekday), position = 'dodge') + facet_wrap(~ tickets$Violation)
#ggplot(data = tickets) + geom_bar(mapping = aes(x = tickets$Fine.Amount, fill = as.factor(tickets$Citation.Issue.Year)), position = "fill") + facet_wrap(~tickets$Violation)

ggplot(data = tickets) + geom_bar(mapping = aes(x = tickets$Fine.Amount, fill = tickets$Citation.Issue.Weekday), position = "fill") + facet_wrap(~tickets$Violation)


#Citation Status
table(tickets$Citation.Status)
ggplot(data = tickets) + geom_bar(mapping = aes(x = tickets$Citation.Status))

#Amount paid
table(tickets$Amount.Paid)
ggplot(data = tickets) + geom_bar(mapping = aes(x = tickets$Amount.Paid))
  #Why are some amounts paid so low? Are these cases where status is open still? 
tickets_by_paid_status <- tickets %>% group_by(Amount.Paid, Citation.Status) 
summary(tickets_by_paid_status)
ggplot(data = tickets_by_paid_status) + geom_bar(mapping = aes(x = tickets$Amount.Paid, fill = tickets$Citation.Status))
  #Most of these ones are still open but it still doesn't make sense
  #What types of violations are these????
tickets_paid_viol <- tickets %>% group_by(Amount.Paid, Violation)
ggplot(data = tickets_paid_viol) + geom_bar(mapping = aes(x = tickets$Amount.Paid, fill = tickets$Violation))
  #Looks like prices of violations vary. By time? Weekend? 

#Amount Due
table(tickets$Amount.Due)
ggplot(data = tickets) + geom_histogram(mapping = aes(x = tickets$Amount.Due, fill = tickets$Violation))
  ##The vast majority of tickets are fully paid off
head(table(tickets$Amount.Due)) 
  ##By citations status?
tickets_due_status <- tickets %>% group_by(Amount.Due, Citation.Status)
summary(tickets_due_status)
ggplot(data = tickets_due_status) + geom_histogram(mapping = aes(x = tickets$Amount.Due, fill = tickets$Citation.Status))
  #That seems to tell the whole story

#Paid on time
table(tickets$Paid.On.Time)
ggplot(data = tickets) + geom_bar(mapping = aes(x = as.factor(tickets$Paid.On.Time)))

```


```{r EDA of Time variables, tidy=T, message=F}
# Month
table(tickets$Citation.Issue.Month)
ggplot(data = tickets) + geom_bar(mapping = aes(x = tickets$Citation.Issue.Month))

# Year
table(tickets$Citation.Issue.Year)
ggplot(data = tickets) + geom_bar(mapping = aes(x = tickets$Citation.Issue.Year))

# Day of Week 
table(tickets$Citation.Issue.DayOfWeek)
ggplot(data = tickets) + geom_bar(mapping = aes(x = tickets$Citation.Issue.DayOfWeek))
# ******* Let's look at how we coded the Day of Week variable. This trend shoud be lower on Sunday ******

# Weekday
table(tickets$Citation.Issue.Weekday)
ggplot(data = tickets) + geom_bar(mapping = aes(x = tickets$Citation.Issue.Weekday))
# ******* Let's look at how we coded the Day of Week variable. This trend shoud be lower on Sunday ******

#Hour 
table(tickets$Citation.Issue.Hour)
ggplot(data = tickets) + geom_bar(mapping = aes(x = tickets$Citation.Issue.Hour))
# People are getting boned during rush hour on the way home

#Summary stats for the different tickets datasets for years
summary(tickets)
# summary(tickets_to2014)
# summary(tickets)
```

##How have the prices of TOLE violations changed over time?

```{r prices change over time EDA, tidy=T, message=F}
#summary stats and bar chart of fine amount
summary(tickets$Violation)
ggplot(data = tickets) + geom_bar(mapping = aes(x = tickets$Violation))
  #Violations broken down by year
ggplot(data = tickets) + geom_bar(mapping = aes(x = tickets$Violation, fill = as.factor(tickets$Citation.Issue.Year)), position = "dodge")

#Because the distribution of fine amount has several high-end outliers, we should be using the median as our measure of central tendency. This is even more clear when comparing the difference between the mean and median (112.7 and 85). 
median(tickets$Fine.Amount)
mean(tickets$Fine.Amount)
median(tickets$Fine.Amount)
mean(tickets$Fine.Amount)

# find the median fine amount by violation
fine_by_viol <- tickets %>% 
  group_by(Violation) %>% 
  summarise(median = median(Fine.Amount))
fine_by_viol

#Maybe put these results in a table?

# find the median fine amount by year
fine_by_year <- tickets %>%
  group_by(Citation.Issue.Year) %>% 
  summarise(median = median(Fine.Amount))
head(fine_by_year)

#plot median fine amount by year to see trend in prices over time
fine.plot.year <- ggplot(data = fine_by_year, aes(x = Citation.Issue.Year, y = median))
fine.plot.year <- fine.plot.year + geom_line() + geom_point() 
fine.plot.year
# *******Median fine amount per year seems to have increased significantly over time. Index with inflation to see if this is really the case?*******

#fine amount by year, violation
fine_by_year_viol <- tickets %>% 
  group_by(Violation,Citation.Issue.Year) %>% 
  summarise(median = median(Fine.Amount))
head(fine_by_year_viol)

#plot fine by year and violation to see change and trends
fine.plot.yv <- ggplot(data = fine_by_year_viol, aes(x = Citation.Issue.Year, y = median))
fine.plot.yv <- fine.plot.yv + geom_line() + geom_point() 
fine.plot.yv <- fine.plot.yv + facet_wrap(~ Violation)
fine.plot.yv

# ********** Looks like we should look at violations and the years they occur in and maybe get more specific on type of violation*********

```

##Are more citations issued on certain days of the week? Are more tickets issued on weekdays than weekends?

#Jack EDA


```{r Cost Change of Each Violation Type over Hour, Day, Month, and Year}
# These graphs show how Fine Amount changes over each hour, day of the week, month, and year for each Violation Type

ggplot(tickets, aes(x = Citation.Issue.Hour, y = Fine.Amount)) + geom_point() + facet_wrap(~Violation)

ggplot(tickets, aes(x = Citation.Issue.DayOfWeek, y = Fine.Amount)) + geom_point() + facet_wrap(~Violation)

ggplot(tickets, aes(x = Citation.Issue.Month, y = Fine.Amount)) + geom_point() + facet_wrap(~Violation)

ggplot(tickets, aes(x = Citation.Issue.Year, y = Fine.Amount)) + geom_point() + facet_wrap(~Violation)

# There are appears to be no change over Hour, Day, or Month with a slight increase in prices each year, with a larger spike in 2012. 
```

```{r Cost of six main violations over Year}
#Analysis of price changes over the years by Violation type

#Total of each type of Violation
ViolationCount <- tickets %>% group_by(Violation) %>% summarise(count = n())
ViolationCount

#Create objects for each type of Violation
Violation.DBLPRK <- tickets %>% filter(Violation == "DBL PARK")
Violation.BUSZONE <- tickets %>% filter(Violation == "BUS ZONE")
Violation.PKPHBOTD <- tickets %>% filter(Violation == "PK PHB OTD")
Violation.PRKPROHIB <- tickets %>% filter(Violation == "PRK PROHIB")
Violation.TOWAWAY1 <- tickets %>% filter(Violation == "TWAWY ZN#1")
Violation.TOWAWAYzONE <- tickets %>% filter(Violation == "TWAWY ZONE")

#Graphing the change in fine for each Violation type from 2010-2015

ggplot(Violation.DBLPRK, aes(x = Citation.Issue.Year, y = Fine.Amount)) + geom_point() + labs(title = "Double Parking")

ggplot(Violation.BUSZONE, aes(x = Citation.Issue.Year, y = Fine.Amount)) + geom_point() + labs(title = "Bus Zone")

ggplot(Violation.PKPHBOTD, aes(x = Citation.Issue.Year, y = Fine.Amount)) + geom_point() + labs(title = "Tow-Away Zone - Outside Downtown Core")

ggplot(Violation.PRKPROHIB, aes(x = Citation.Issue.Year, y = Fine.Amount)) + geom_point() + labs(title = "Tow-Away Zone - Downtown Core")

ggplot(Violation.TOWAWAY1, aes(x = Citation.Issue.Year, y = Fine.Amount)) + geom_point() + labs(title = "Tow Away Zone 1")

ggplot(Violation.TOWAWAYzONE, aes(x = Citation.Issue.Year, y = Fine.Amount)) + geom_point() + labs(title = "Tow Away Zone 2")

#General increases in fines over the interval with a noticable jump in prices in 2012
```


## What Hours have the most Violations

```{r Histogram of Citations per Hour, tidy = T}
# Histogram of Citations per Hour
ByHour <- tickets %>% group_by(Citation.Issue.Hour) %>% summarise(Percentage = round(n()/nrow(tickets) * 100, digits = 5))
ByHour

ggplot(tickets, aes(x = Citation.Issue.Hour)) + geom_histogram(binwidth = 1, fill = "red", color = "black") + scale_x_continuous(breaks = seq(0, 24, 1)) 
```

## Are more tickets issued during Rush Hour or Off Hours

```{r}
#Created variable Day of Month for purposes of day-to-day calculations
tickets$Citation.Issue.Day <- day(tickets$Citation.Issue.Date)


RushHour <- tickets %>% filter((Citation.Issue.Hour >= 7 & Citation.Issue.Hour <= 9) | (Citation.Issue.Hour >= 16 & Citation.Issue.Hour <= 18))
NonRushHour <- tickets %>% filter((Citation.Issue.Hour < 7 | Citation.Issue.Hour > 9) & (Citation.Issue.Hour < 16 | Citation.Issue.Hour > 18))
nrow(RushHour)
nrow(NonRushHour)
PercentRush <- nrow(RushHour) / nrow(tickets) * 100
PercentRush
```

```{r}
t <- tickets %>% group_by(Citation.Issue.Date) %>% summarise(median = median(Fine.Amount))
median(t$median)

g <- tickets %>% group_by(Citation.Issue.DayOfWeek) %>% summarise(median = median(Fine.Amount))
g

```


## Comparing Distributions of Rush Hour and Off Hour Totals per Day 

```{r EDA for Rushhour and NonRushhour}
#EDA for Rushhour vs NonRushhour
dim(RushHour)
str(RushHour)
nrow(RushHour)
head(RushHour)

#Calculate total Rushhour violations for each day
Rush <- RushHour %>% group_by(Citation.Issue.Day, Citation.Issue.Month, Citation.Issue.Year) %>% summarise(count = n())
RushTotals <- Rush$count

#EDA of Statistics of Rushhour
mean(RushTotals)
median(RushTotals)
var(RushTotals)
sd(RushTotals)
quantile(RushTotals, c(0, .1, .2, .3, .4, .5, .6, .7, .8, .9, .95, 1))
shapiro.test(RushTotals)

#EDA Graphs for Rushhour
qqnorm(RushTotals)
qqline(RushTotals)

boxplot(RushTotals)

plot(RushTotals, dbinom(RushTotals, 30, 0.25), type = "h")

#EDA of NonRushhour
str(NonRushHour)
dim(NonRushHour)
nrow(NonRushHour)

NonRush <- NonRushHour %>% group_by(Citation.Issue.Day, Citation.Issue.Month, Citation.Issue.Year) %>% summarise(count = n())
NonRushTotals <- NonRush$count

mean(NonRushTotals)
median(NonRushTotals)
sd(NonRushTotals)
var(NonRushTotals)
quantile(NonRushTotals, c(0, .1, .2, .3, .4, .5, .6, .7, .8, .9, .95, 1))
shapiro.test(NonRushTotals)
qqnorm(NonRushTotals)
qqline(NonRushTotals)

boxplot(NonRushTotals)

ggplot(Rush, aes(x = count)) + geom_histogram(binwidth = 1, fill = "red", color = "black") + scale_x_continuous(breaks = seq(0, 130, 10)) + geom_histogram(data = NonRush, aes(x = count), binwidth = 1, fill = "blue", color = "black", alpha = 0.7) + scale_x_continuous(breaks = seq(0, 130, 10)) 

plot(NonRushTotals, dbinom(NonRushTotals, 30, 0.25), type = "h")

```

## What Violations occur more during Rush Hour and what occur more during Off Hours?

```{r Violation Type per Hour}
# Proportion of Violation Type per Hour

Tickets.per.Hour <- tickets %>% group_by(Citation.Issue.Hour) %>% summarise(count = n())
Tickets.per.Hour

ggplot(tickets, aes(x = Citation.Issue.Hour, fill = Violation)) + geom_bar(position = "fill") + scale_x_continuous(breaks = seq(0, 24, 1)) 

# Graph shows almost entirely Double Parking and Bus Zone Violations during non-rush-hour  and almost entirely Towaway and Prohibited Parking during rush hour

Violation.Rush <- RushHour %>% group_by(Violation) %>% summarise(Total_During_Rush = n())
Violation.Rush

Violation.Off <- NonRushHour %>% group_by(Violation) %>% summarise(Total_During_Off = n())
Violation.Off

a <- Violation.Rush$Total_During_Rush / (Violation.Rush$Total_During_Rush + Violation.Off$Total_During_Off)
a <- round(a, 3)

```
